# 
# Do NOT Edit the Auto-generated Part!
# Generated by: spectacle version 0.23
# 
# >> macros
# << macros

Name:       obslight-fakeobs
Summary:    Python script that acts as an OBS API
Version:    0.5
Release:    1
Group:      Development/Tools/Building
License:    GPLv2
BuildArch:  noarch
URL:        https://meego.gitorious.org/meego-developer-tools/obs-light/trees/master
Source0:    %{name}-%{version}.tar.gz
Source100:  obslight-fakeobs.yaml
%if 0%{?fedora}
Requires:   httpd
Requires:   redhat-lsb
%else
Requires:   apache2
Requires(post): sysconfig
%endif

Requires:   bash
Requires:   git
Requires:   logrotate
Requires:   osc
Requires:   python
Requires:   python-async
Requires:   python-gitdb
Requires:   python-gitpython
Requires:   python-smmap

Requires(post): /sbin/service
Requires(post): /sbin/chkconfig
Requires(postun): /sbin/service
Requires(postun): /sbin/chkconfig


%description
Python script that partially implement an OBS API.
It is based on Mer Delivery System.




%prep
%setup -q -n %{name}

# >> setup
# << setup

%build
# >> build pre
# << build pre



# >> build post
# << build post
%install
rm -rf %{buildroot}
# >> install pre
mkdir -p %{buildroot}/srv/fakeobs/obs-projects
mkdir -p %{buildroot}/srv/fakeobs/obs-repos
mkdir -p %{buildroot}/srv/fakeobs/packages-git
mkdir -p %{buildroot}/srv/fakeobs/releases
mkdir -p %{buildroot}%{_sysconfdir}/init.d
mkdir -p %{buildroot}%{_sysconfdir}/logrotate.d
mkdir -p %{buildroot}%{_sbindir}
mkdir -p %{buildroot}%{_bindir}
mkdir -p %{buildroot}%{_docdir}/%{name}
cp -rf tools %{buildroot}/srv/fakeobs/tools
cp -rf config %{buildroot}/srv/fakeobs/config
cp -rf theme %{buildroot}/srv/fakeobs/theme
cp -f obslight-fakeobs %{buildroot}%{_bindir}
cp -f init_fakeobs %{buildroot}%{_sysconfdir}/init.d/fakeobs
cp -f init_fakeobswebui %{buildroot}%{_sysconfdir}/init.d/fakeobswebui
cp -f logrotate_fakeobs %{buildroot}%{_sysconfdir}/logrotate.d/fakeobs
cp -f README %{buildroot}%{_docdir}/%{name}
echo "%{name}-%{version}-%{release}" > %{buildroot}%{_docdir}/%{name}/VERSION

ln -sf /srv/fakeobs/tools/fakeobs.py %{buildroot}%{_sbindir}/fakeobs
ln -sf %{_sysconfdir}/init.d/fakeobs %{buildroot}%{_sbindir}/rcfakeobs
ln -sf /srv/fakeobs/tools/fakeobswebui.py %{buildroot}%{_sbindir}/fakeobswebui
ln -sf %{_sysconfdir}/init.d/fakeobswebui %{buildroot}%{_sbindir}/rcfakeobswebui
# << install pre

# >> install post
# << install post


%preun
# >> preun
%stop_on_removal fakeobs
if [ $1 -eq 0 ] ; then
/sbin/chkconfig --del fakeobs
fi
%stop_on_removal fakeobswebui
if [ $1 -eq 0 ] ; then
/sbin/chkconfig --del fakeobswebui
fi
# << preun

%post
# >> post
cd /srv/fakeobs/
if [ ! -f lastevents ]
then
touch lastevents
sh tools/addevent initial na na
fi

if [ ! -f mappings.xml ]
then
echo -e "<mappings>\n</mappings>" > mappings.xml
fi

if [ -d "%{_sysconfdir}/apache2/vhosts.d" ]
then
# openSUSE
  APACHEVHOST="%{_sysconfdir}/apache2/vhosts.d"
elif [ -d "%{_sysconfdir}/httpd/conf.d" ]
then
# Fedora
  APACHEVHOST="%{_sysconfdir}/httpd/conf.d"
fi


if [ -d %{_sysconfdir}/apache2/vhosts.d ]
then
ln -sf /srv/fakeobs/config/fakeobs-repos.apache2conf "$APACHEVHOST"/fakeobs-repos.conf
fi
if [ -d %{_sysconfdir}/lighttpd/vhosts.d ]
then
ln -sf /srv/fakeobs/config/fakeobs-repos.lighttpdconf "$APACHEVHOST"/fakeobs-repos.conf
fi

OVERVIEW="/srv/www/obs/overview/index.html"
if [ -f $OVERVIEW ]
then
if ! $(grep -q fakeobs $OVERVIEW)
then
cat >> $OVERVIEW << EOF
<p><a href=http://obslightserver:8001>The fakeobs API URL(http://obslightserver:8001)</a> is used by the "fakeobs" project link.</p>
<p><a href=http://obslightserver:8002>The fakeobs repositories</a> contain the static build results, the repositories can be added to package managers like zypper or apt.</p>
EOF
fi
fi
#/sbin/chkconfig --add fakeobs
%{fillup_and_insserv -f -y fakeobs}
%{fillup_and_insserv -f -y fakeobswebui}
# << post

%postun
# >> postun
%restart_on_update fakeobs
%restart_on_update fakeobswebui
%insserv_cleanup

OVERVIEW="/srv/www/obs/overview/index.html"
if [ "$1" -eq "0" ]
then
if [ -f $OVERVIEW ]
then
if $(grep -q fakeobs $OVERVIEW)
then
cp -f "$OVERVIEW" "$OVERVIEW.old"
grep -v fakeobs "$OVERVIEW.old" > "$OVERVIEW"
fi
fi
fi
# << postun


%files
%defattr(-,root,root,-)
# >> files
%dir /srv/fakeobs
%dir /srv/fakeobs/obs-projects
%dir /srv/fakeobs/obs-repos
%dir /srv/fakeobs/packages-git
%dir /srv/fakeobs/releases
%dir /srv/fakeobs/tools
%dir /srv/fakeobs/config
%dir /srv/fakeobs/theme
/srv/fakeobs/tools/*
/srv/fakeobs/config/*
/srv/fakeobs/theme/*
%config %{_sysconfdir}/init.d/fakeobs
%config %{_sysconfdir}/init.d/fakeobswebui
%config %{_sysconfdir}/logrotate.d/fakeobs
%{_sbindir}/fakeobs
%{_sbindir}/fakeobswebui
%{_sbindir}/rcfakeobs
%{_sbindir}/rcfakeobswebui
%{_bindir}/obslight-fakeobs
%{_docdir}/%{name}
# << files


